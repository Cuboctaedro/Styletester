(function(e){e.cursor=function(t){var n=e(t);var r=n[0];var i=n.val();if(!r.createTextRange)return r.selectionEnd;var s=document.selection.createRange().duplicate();s.moveEnd("character",i.length);if(s.text=="")return i.length;return i.lastIndexOf(s.text)};var t=function(t){var n=this;this.source=e(t);this.element=e("<div />");this.input=e('<input class="tag-input" type="text" autocomplete="off" />');this.tags=[];this.elements={};this.cursor=0;this.autocomplete=this.source.data("url");this.lowercase=this.source.data("lowercase");this.separator=this.source.data("separator");if(!this.separator)this.separator=",";this.keys=function(e,t){e.on("keydown",function(e){if(t[e.keyCode]){return t[e.keyCode]()}})};this.next=function(e){return n.get(e).next()};this.prev=function(e){return n.get(e).prev()};this.first=function(){return n.element.find(".tag").first()};this.last=function(){return n.element.find(".tag").last()};this.goto=function(e,t){n[e](t).trigger("focus")};this.clean=function(t){var t=e.trim(t);if(n.lowercase)t=t.toLowerCase();return t};this.get=function(t){return n.elements.filter(function(n,r){return e(this).data("tag")==t.toLowerCase()})};this.select=function(e){return n.get(e).trigger("focus")};this.deselect=function(e){return n.get(e).trigger("blur")};this.store=function(){n.source.val(n.tags.join(n.separator))};this.add=function(t){if(!t)t=n.input.val();var t=n.clean(t);var r=new RegExp(n.separator);if(t.match(r)){e.each(t.split(n.separator),function(e,t){n.add(t)});return}if(e.type(t)=="array"){e.each(t,function(e,t){n.add(t)});return}if(!t||t.length==0||e.inArray(t,n.tags)!=-1){return false}n.tags.push(t);var i=e('<span data-tag="'+t.toLowerCase()+'" tabindex="-1" class="tag"></span>');var s=e('<i class="tag-x">&times;</i>');var o=e('<button class="tag-label" type="button">'+t+"</button>");i.append(o).append(s);i.on("focus",function(){o.focus()});i.on("click",function(e){e.stopPropagation()});s.on("click",function(e){n.remove(t)});n.keys(o,{8:function(){n.remove(t);return false},27:function(){n.focus()},37:function(){n.goto("prev",t);return false},39:function(){n.goto("next",t);return false}});n.input.before(i);n.elements=n.element.find(".tag");n.input.val("");n.store();if(n.autocomplete){n.input.data("autocomplete").ignore(t)}n.element.trigger("tags:add")};this.focus=function(){n.input.trigger("focus")};this.remove=function(t){n.tags=e.grep(n.tags,function(e){return e!=t});var r=n.prev(t).data("tag");n.get(t).remove();n.elements=n.element.find(".tag");if(!r){var r=n.first().data("tag");r?n.select(r):n.focus()}else{n.select(r)}n.store();if(n.autocomplete){n.input.data("autocomplete").unignore(t)}n.element.trigger("tags:remove")};this.init=function(){n.element.attr("class",n.source.attr("class"));n.input.attr("id",n.source.attr("id"));n.source.attr("type","hidden").attr("id","").removeClass();n.source.before(n.element);n.element.append(n.input);if(n.autocomplete){n.input.data("url",n.autocomplete);n.input.data("limit",5);n.input.data("sticky",true);n.input.autocomplete();n.input.on("autocomplete:add",function(){n.add()});n.element.on("tags:add",function(){n.input.data("autocomplete").close()})}n.element.on("click",function(){n.focus()});n.element.on("focusin",function(){n.element.addClass("input-is-focused");n.element.trigger("tags:focus")});n.element.on("focusout",function(){n.element.removeClass("input-is-focused");n.element.trigger("tags:blur")});n.measure=e("<div></div>").css({display:"inline","font-size":n.input.css("font-size"),"font-family":n.input.css("font-family"),padding:n.input.css("padding"),visibility:"hidden",position:"absolute",top:-1e4,left:-1e4});e("body").append(n.measure);n.keys(n.input,{13:function(){n.add();return false},9:function(){if(n.input.val().length==0){return true}else{n.add();return false}},188:function(){n.add();return false},8:function(){if(n.cursor==0){n.goto("last");return false}},37:function(){if(n.cursor==0){n.goto("last");return false}}});n.input.on("keydown, keyup",function(){n.measure.text(n.input.val());n.input.css("width",n.measure.outerWidth()+50);n.cursor=e.cursor(n.input)});n.add(n.source.val());n.element.trigger("tags:init");return{add:n.add,get:n.get,remove:n.remove,focus:n.focus,select:n.select,tags:function(){return n.tags},elements:function(){return n.elements},input:function(){return n.input}}};return this.init()};e.fn.tags=function(){return this.each(function(){if(e(this).data("tags")){return e(this).data("tags")}else{var n=new t(this);e(this).data("tags",n);return n}})}})(jQuery);